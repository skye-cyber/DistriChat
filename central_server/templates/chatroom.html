{% extends 'base.html' %} {% block content %}
<div class="h-screen flex flex-col bg-gray-100">
  <!-- Chat Header -->
  <div class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center">
          <a
            href="{% url 'chat:dashboard' %}"
            class="mr-4 text-gray-500 hover:text-gray-700"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              />
            </svg>
          </a>
          <div>
            <h1 class="text-2xl font-bold text-gray-900">{{ room.name }}</h1>
            <p class="text-sm text-gray-600">
              {{ room.member_count }} members â€¢ Node: {{ room.node.name }}
            </p>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <span
            class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800"
          >
            <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
            Online
          </span>
          <button
            onclick="showMembers()"
            class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition duration-300"
          >
            Members
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="flex-1 flex max-w-7xl mx-auto w-full">
    <!-- Messages Area -->
    <div class="flex-1 flex flex-col">
      <!-- Messages Container -->
      <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4">
        {% for message in messages %}
        <div
          class="message-enter {% if message.sender == user %}bg-blue-50 border-blue-200{% else %}bg-white border-gray-200{% endif %} border rounded-lg p-4 max-w-3xl {% if message.sender == user %}ml-auto{% endif %}"
        >
          <div class="flex items-start space-x-3">
            <div
              class="flex-shrink-0 w-8 h-8 bg-{{ message.sender.color }}-500 rounded-full flex items-center justify-center text-white text-sm font-bold"
            >
              {{ message.sender.username|first|upper }}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center space-x-2">
                <span class="text-sm font-semibold text-gray-900"
                  >{{ message.sender.username }}</span
                >
                <span class="text-xs text-gray-500"
                  >{{ message.timestamp|time:"H:i" }}</span
                >
              </div>
              <p class="text-gray-800 mt-1">{{ message.content }}</p>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Message Input -->
      <div class="bg-white border-t p-4">
        <form id="message-form" class="flex space-x-4">
          {% csrf_token %}
          <input type="hidden" id="room-id" value="{{ room.id }}" />

          <div class="flex-1">
            <input
              type="text"
              id="message-input"
              placeholder="Type your message..."
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
          <button
            type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition duration-300 flex items-center"
          >
            <svg
              class="w-5 h-5 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
              />
            </svg>
            Send
          </button>
        </form>
      </div>
    </div>

    <!-- Online Members Sidebar -->
    <div id="members-sidebar" class="w-80 bg-white border-l hidden lg:block">
      <div class="p-4 border-b">
        <h3 class="text-lg font-semibold text-gray-900">Online Members</h3>
      </div>
      <div class="p-4 space-y-3">
        {% for member in online_members %}
        <div class="flex items-center space-x-3">
          <div class="relative">
            <div
              class="w-10 h-10 bg-{{ member.color }}-500 rounded-full flex items-center justify-center text-white font-bold"
            >
              {{ member.username|first|upper }}
            </div>
            <div
              class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 border-2 border-white rounded-full"
            ></div>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-900">
              {{ member.username }}
            </p>
            <p class="text-xs text-gray-500">Active now</p>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // WebSocket connection
  const roomId = document.getElementById("room-id").value;
  const chatSocket = new WebSocket(
    "ws://" + window.location.host + "/ws/chat/" + roomId + "/",
  );

  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    const messagesContainer = document.getElementById("messages-container");

    const messageElement = document.createElement("div");
    messageElement.className = `message-enter ${data.sender === "{{ user.username }}" ? "bg-blue-50 border-blue-200 ml-auto" : "bg-white border-gray-200"} border rounded-lg p-4 max-w-3xl`;

    messageElement.innerHTML = `
        <div class="flex items-start space-x-3">
            <div class="flex-shrink-0 w-8 h-8 bg-${data.color}-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                ${data.sender.charAt(0).toUpperCase()}
            </div>
            <div class="flex-1 min-w-0">
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-semibold text-gray-900">${data.sender}</span>
                    <span class="text-xs text-gray-500">${new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</span>
                </div>
                <p class="text-gray-800 mt-1">${data.message}</p>
            </div>
        </div>
    `;

    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  };

  chatSocket.onclose = function (e) {
    console.error("Chat socket closed unexpectedly");
  };

  // Message form submission
  document.getElementById("message-form").onsubmit = function (e) {
    e.preventDefault();

    const messageInput = document.getElementById("message-input");
    const message = messageInput.value;

    if (message) {
      chatSocket.send(
        JSON.stringify({
          message: message,
          sender: "{{ user.username }}",
        }),
      );
      messageInput.value = "";
    }
  };

  // Auto-focus message input
  document.getElementById("message-input").focus();

  // Scroll to bottom of messages
  const messagesContainer = document.getElementById("messages-container");
  messagesContainer.scrollTop = messagesContainer.scrollHeight;

  // Toggle members sidebar on mobile
  function showMembers() {
    const sidebar = document.getElementById("members-sidebar");
    sidebar.classList.toggle("hidden");
  }

  // Handle Enter key for sending messages
  document
    .getElementById("message-input")
    .addEventListener("keypress", function (e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        document
          .getElementById("message-form")
          .dispatchEvent(new Event("submit"));
      }
    });
</script>
{% endblock %}
