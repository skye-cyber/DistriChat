{% extends 'base.html' %}
{% load static %}
{% block title %}Chat Room: {{ room.name }} - DistriChat{% endblock %}
{% block content %}
{% block header %}
    {# disable header #}
{% endblock %}

<div class="fixed z-[0] top-0 bottom-0 left-0 right-0 h-screen w-screen flex flex-col bg-gradient-to-br from-gray-50 to-blue-50 overflow-hidden">
  <span id="user_meta" class="hidden" data-username="{{ user.username }}" data-initials="{{ user.username|first|upper }}"></span>
  <!-- Chat Header -->
  <div class="bg-white shadow-lg border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center space-x-4">
          <a
            href="{% url 'chat:dashboard' %}"
            class="text-gray-500 hover:text-gray-700 transition-colors duration-200 transform hover:scale-110"
          >
            <svg
              class="w-4 h-4 md:w-6 md:h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 19l-7-7m0 0l7-7m-7 7h18"
              />
            </svg>
          </a>
          <div class="flex items-center space-x-3">
            <div
              class="w-8 h-8 p-2 md:p-0 md:w-12 md:h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg"
            >
              <svg
                class="w-6 h-6 text-white"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                />
              </svg>
            </div>
            <div>
              <h1 class="text-lg md:text-xl lg:text-2xl font-bold text-gray-900">{{ room.name }}</h1>
              <div class="flex items-center space-x-1 sm:space-x-4 text-sm text-gray-600">
                <span class="flex items-center space-x-1">
                  <div
                    class="w-2 h-2 bg-green-500 rounded-full pulse-animation"
                  ></div>
                  <span class="flex gap-1"><span id="online-display">{{ online_members.count }}</span> online</span>
                </span>
                <span>•</span>
                <span class="flex gap-1"><span id="membership-display">{{ room.member_count }}</span> total <span class="hidden sm:flex"> members</span></span>
                <span>•</span>
                <span class="flex items-center space-x-1">
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"
                    />
                  </svg>
                  <span class="hidden sm:flex">Node: {{ room.node.name }}</span>
                </span>
              </div>
            </div>
          </div>
        </div>

        <div class="flex items-center space-x-1 sm:space-x-4">
          <!-- Room Actions -->
          <div class="flex items-center space-x-1 sm:space-x-2">
            <button
              onclick="toggleMembersSidebar()"
              class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-2 rounded-lg transition-all duration-200 hover:scale-105 flex items-center space-x-2"
            >
              <svg class="w-6 h-6 text-blue-700 fill-blue-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M320 80C377.4 80 424 126.6 424 184C424 241.4 377.4 288 320 288C262.6 288 216 241.4 216 184C216 126.6 262.6 80 320 80zM96 152C135.8 152 168 184.2 168 224C168 263.8 135.8 296 96 296C56.2 296 24 263.8 24 224C24 184.2 56.2 152 96 152zM0 480C0 409.3 57.3 352 128 352C140.8 352 153.2 353.9 164.9 357.4C132 394.2 112 442.8 112 496L112 512C112 523.4 114.4 534.2 118.7 544L32 544C14.3 544 0 529.7 0 512L0 480zM521.3 544C525.6 534.2 528 523.4 528 512L528 496C528 442.8 508 394.2 475.1 357.4C486.8 353.9 499.2 352 512 352C582.7 352 640 409.3 640 480L640 512C640 529.7 625.7 544 608 544L521.3 544zM472 224C472 184.2 504.2 152 544 152C583.8 152 616 184.2 616 224C616 263.8 583.8 296 544 296C504.2 296 472 263.8 472 224zM160 496C160 407.6 231.6 336 320 336C408.4 336 480 407.6 480 496L480 512C480 529.7 465.7 544 448 544L192 544C174.3 544 160 529.7 160 512L160 496z"/></svg>
              </svg>
              <span class="hidden sm:flex">Members</span>
            </button>

            {% if user == room.created_by or user_membership.role == 'admin' %}
            <button
              onclick="showRoomSettings()"
              class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-all duration-200 hover:scale-105 flex items-center space-x-1 sm:space-x-2"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
              </svg>
              <span class="hidden sm:flex">Settings</span>
            </button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="flex-1 flex max-w-full md:max-w-7xl lg:max-w-full mx-auto w-full h-[100vh] max-h-[79vh] sm:max-h-[82vh] md:max-h-[88vh]">
    <!-- Messages Area -->
    <div class="flex-1 flex flex-col">
      <!-- Messages Container -->
      <div
        id="messages-container"
        class="flex-1 overflow-y-auto p-6 space-y-4 messages-container bg-white/80 backdrop-blur-sm"
      >
        <!-- Welcome Message -->
        <div class="text-center py-8">
          <div
            class="w-12 h-12 md:w-16 md:h-16 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg"
          >
            <svg
              class="w-8 h-8 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
              />
            </svg>
          </div>
          <h3 class="text-[14px] md:text-lg font-semibold text-gray-900 mb-1 md:mb-2">
            Welcome to {{ room.name }}!
          </h3>
          <p class="text-sm text-gray-600">
            This is the beginning of your conversation.
          </p>
        </div>
        <!-- Sample Messages (will be replaced by real messages) -->
        {% for message in messages %}
        <div
          class="message-item {% if message.sender == user %}message-sent{% else %}message-received{% endif %} animate-fade-in"
        >
          <div
            class="flex space-x-1 w-fit max-w-2xl {% if message.sender == user %}ml-auto{% endif %}"
          >
            {% if message.sender != user %}
            <div class="flex-shrink-0 -mt-2">
              <div
                class="size-5 sm:size-8 lg:size-9 bg-gradient-to-r from-{{ message.sender.color_scheme }}-500 to-{{ message.sender.color_scheme }}-600 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg"
              >
                {{ message.sender.username|first|upper }}
              </div>
            </div>
            {% endif %}

            <div
              class="flex-1 mt-1 {% if message.sender == user %}text-right{% endif %}"
            >
              <div
                class="{% if message.sender == user %}bg-indigo-500 text-white rounded-tr-none{% else %}bg-white border border-gray-200 rounded-tl-none{% endif %} rounded-2xl px-3 py-1 shadow-sm hover:shadow-md transition-all duration-200"
              >
                {% if message.sender != user %}
                <p class="text-[12px] font-semibold text-gray-900 mb-1">
                  {{ message.sender.username }}
                </p>
                {% endif %}
                <p
                  class="{% if message.sender == user %}text-white{% else %}text-gray-800{% endif %} leading-relaxed"
                >
                  {{ message.content }}
                </p>
                <p
                  class="flex text-xs justify-end {% if message.sender == user %}text-blue-100{% else %}text-gray-500{% endif %} mt-0.5"
                >
                  {% if message.is_edited %}
                  <span class="italic">(edited)</span>
                  {% endif %}{{ message.timestamp|time:"H:i" }}
                </p>
              </div>

              <!-- Message Reactions -->
              <div
                class="flex items-center space-x-2 mt-1 {% if message.sender == user %}justify-end{% endif %}"
              >
                <button
                  class="text-gray-400 hover:text-gray-600 transition-colors text-sm"
                >
                  👍
                </button>
                <button
                  class="text-gray-400 hover:text-gray-600 transition-colors text-sm"
                >
                  ❤️
                </button>
                <button
                  class="text-gray-400 hover:text-gray-600 transition-colors text-sm"
                >
                  😮
                </button>
                <button
                  onclick="showMessageActions('{{ message.id }}')"
                  class="text-gray-500 hover:text-gray-600 transition-colors text-sm"
                >
                  ⋮
                </button>
              </div>
            </div>

            {% if message.sender == user %}
            <div class="flex-shrink-0 -mt-2">
              <div
                class="size-5 sm:size-8 lg:size-9 bg-gradient-to-r from-green-500 to-teal-600 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg"
              >
                {{ message.sender.username|first|upper }}
              </div>
            </div>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Typing Indicator -->
      <div
        id="typing-indicator"
        class="hidden bg-white/80 backdrop-blur-sm px-6 py-2 border-t border-gray-100"
      >
        <div class="flex items-center space-x-2 text-gray-500">
          <div class="flex space-x-1">
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
            <div
              class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"
              style="animation-delay: 0.1s"
            ></div>
            <div
              class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"
              style="animation-delay: 0.2s"
            ></div>
          </div>
          <span class="text-sm font-medium" id="typing-users"></span>
        </div>
      </div>

      <!-- Message Input -->
      <div class="bg-white border-t border-gray-200 p-2 md:p-6">
        <form id="message-form" class="flex space-x-0 space-l-1 sm:space-x-4 items-end">
          {% csrf_token %}
          <input type="hidden" id="room-id" value="{{ room.id }}" />

          <!-- Message Input -->
          <div class="flex-1 relative">
            <textarea
              id="message-input"
              placeholder="Type your message..."
              rows="1"
              class="w-full px-4 py-3 border border-gray-300 rounded-2xl focus:outline outline-blue-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none transition-all duration-200 max-h-32"
              oninput="autoResize(this); handleTyping()"
            ></textarea>

            <!-- Quick Actions -->
            <div class="absolute right-3 bottom-3 flex items-center space-x-2">
              <button
                type="button"
                class="text-gray-400 hover:text-gray-600 transition-colors"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </button>
              <button
                type="button"
                class="text-gray-400 hover:text-gray-600 transition-colors"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"
                  />
                </svg>
              </button>
            </div>
          </div>

          <!-- Send Button -->
          <button
            type="submit"
            id="send-button"
            class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-2 py-2 md:px-6 py-3 rounded-2xl font-semibold transition-all duration-200 hover:scale-105 shadow-lg flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 5l7 7-7 7M5 5l7 7-7 7"
              />
            </svg>
            <span class="hidden lg:flex">Send</span>
          </button>
        </form>
      </div>
    </div>


    <!-- Online Members Sidebar -->
    <div
      id="members-sidebar"
      class="w-80 bg-white border-l border-gray-200 transform transition-transform duration-300 ease-in-out translate-x-full lg:translate-x-0 lg:static lg:w-80 absolute right-0 top-0 bottom-0 z-[50]"
    >
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-900">Online Members</h3>
          <button
            onclick="toggleMembersSidebar()"
            class="lg:hidden text-gray-400 hover:text-gray-600"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
      </div>

      <div class="p-6 space-y-4 max-h-[calc(100vh-200px)] overflow-y-auto">
        {% for member in online_members %}
        <div
          class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-50 transition-colors duration-200"
        >
          <div class="relative">
            <div
              class="w-10 h-10 bg-gradient-to-r from-{{ member.color_scheme }}-500 to-{{ member.color_scheme }}-600 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg"
            >
              {{ member.username|first|upper }}
            </div>
            <div
              class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 border-2 border-white rounded-full"
            ></div>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-gray-900 truncate">
              {{ member.username }}
            </p>
            <p class="text-xs text-gray-500">Active now</p>
          </div>
          {% if member == room.created_by %}
          <span
            class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full"
            >Owner</span
          >
          {% elif member.membership.role == 'admin' %}
          <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full"
            >Admin</span
          >
          {% endif %}
        </div>
        {% endfor %}

        <!-- Offline Members Section -->
        <div class="pt-6 border-t border-gray-200">
          <h4
            class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4"
          >
            All Members
          </h4>
          <div class="space-y-3">
            {% for member in room.members.all %}
                {% if member not in online_members %}
                <div class="flex items-center space-x-3 p-2 rounded-lg opacity-60">
                <div
                    class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-gray-600 font-bold text-xs"
                >
                    {{ member.username|first|upper }}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-700 truncate">
                    {{ member.username }}
                    </p>
                    <p class="text-xs text-gray-500">Offline</p>
                </div>
                </div>
                {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    <!-- Backdrop for mobile sidebar -->
    <div
      id="sidebar-backdrop"
      class="fixed inset-0 bg-black bg-opacity-50 z-[30] hidden"
    ></div>
  </div>
</div>

<!-- Message Actions Modal -->
<div
  id="message-actions-modal"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
>
  <div
    class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 transform transition-all duration-300 scale-95 opacity-0"
  >
    <div class="p-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900">Message Actions</h3>
    </div>
    <div class="p-2">
      <button
        class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
      >
        Copy Message
      </button>
      <button
        class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
      >
        Reply
      </button>
      {% if user == room.created_by or user_membership.role == 'admin' %}
      <button
        class="w-full text-left px-4 py-3 text-sm text-red-600 hover:bg-red-50 rounded-lg transition-colors"
      >
        Delete Message
      </button>
      {% endif %}
    </div>
    <div class="p-4 border-t border-gray-200">
      <button
        onclick="hideMessageActions()"
        class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors"
      >
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Room Settings Modal -->
<div
  id="room-settings-modal"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
>
  <div
    class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0"
  >
    <div class="p-6 border-b border-gray-200">
      <h3 class="text-xl font-bold text-gray-900">Room Settings</h3>
    </div>
    <div class="p-6 space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Room Name</label
        >
        <input
          type="text"
          name="room_name"
          id="room_name"
          value="{{ room.name }}"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Description</label
        >
        <textarea
          name="room_description"
          id="room_description"
          value="{{ room.description }}"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          rows="3"
        >
{{ room.description }}</textarea
        >
      </div>
    </div>
    <div class="p-6 border-t border-gray-200 flex space-x-3">
      <button
        id="cancel-settings"
        class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors"
      >
        Cancel
      </button>
      <button
        id="update_room"
        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"
      >
        Save Changes
      </button>
    </div>
  </div>
</div>


{% endblock %} {% block extra_js %}
<script src="{% static 'js/chat.js' %}"></script>
{% endblock %}

{% block footer %}
{# disable footer #}
{% endblock %}
